<div class="items-container">
    <div class="items-header">
        4.1 Ítems Homologados
    </div>

    <div class="items-card">
        <div *ngIf="loading()" class="loading-spinner">
            Cargando ítems homologados...
        </div>

        <div *ngIf="error()" class="error-message">
            {{ error() }}
        </div>

        <div *ngIf="!loading() && !error()">
            <div *ngIf="homologaciones().length > 0; else emptyState">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th colspan="3" class="section-header solicited-header">Ítems Solicitados (Extraídos)</th>
                            <th colspan="9" class="section-header matched-header">Ítems Homologados (Catálogo)</th>
                        </tr>
                        <tr>
                            <!-- Solicitados -->
                            <th class="col-num">N°</th>
                            <th class="col-producto">Ítem</th>
                            <th class="col-cantidad">Cantidad</th>

                            <!-- Homologados -->
                            <th class="col-num">Sel</th>
                            <th class="col-num">#</th>
                            <th class="col-medium">Código</th>
                            <th class="col-producto">Nombre</th>
                            <th class="col-large">Descripción</th>
                            <th class="col-small">Stock</th>
                            <th class="col-medium">Ubicación</th>
                            <th class="col-small">Score</th>
                            <th class="col-large">Razonamiento</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor="let item of homologaciones(); let itemIndex = index">
                            <ng-container *ngIf="item.candidatos && item.candidatos.length > 0; else noCandidatos">
                                <tr *ngFor="let candidato of item.candidatos; let isFirst = first">
                                    <!-- Columnas del Ítem Solicitado (con rowspan para agrupar) -->
                                    <!-- ngIf applies when inside the loop to determine grouping layout -->
                                    <td *ngIf="isFirst" [attr.rowspan]="item.candidatos.length">{{ itemIndex + 1 }}</td>
                                    <td *ngIf="isFirst" [attr.rowspan]="item.candidatos.length"><strong>{{
                                            item.nombre_item ||
                                            item.item_key || '' }}</strong></td>
                                    <td *ngIf="isFirst" [attr.rowspan]="item.candidatos.length" class="text-center">{{
                                        item.cantidad || '' }}</td>

                                    <!-- Columnas del Candidato Homologado -->
                                    <td class="text-center">
                                        <input type="checkbox"
                                            [name]="'candidato_' + item.homologacion_id + '_' + candidato.ranking">
                                    </td>
                                    <td class="text-center"><span class="badge"
                                            [class.badge-primary]="candidato.ranking === 1">{{ candidato.ranking
                                            }}</span></td>
                                    <td class="font-monospace text-sm">{{ candidato.producto.codigo || '' }}</td>
                                    <td>{{ candidato.producto.nombre || '' }}</td>
                                    <td class="text-sm description-cell" [title]="candidato.producto.descripcion">{{
                                        candidato.producto.descripcion || '' }}</td>
                                    <td class="text-center"
                                        [class.stock-low]="candidato.producto.stock_disponible !== undefined && candidato.producto.stock_disponible! < item.cantidad">
                                        {{ candidato.producto.stock_disponible !== undefined ?
                                        candidato.producto.stock_disponible : '-' }}</td>
                                    <td class="text-center">{{ candidato.producto.ubicacion_stock || '-' }}</td>
                                    <td class="text-center">
                                        <span class="score-badge" [class.high-score]="candidato.score_similitud > 0.8"
                                            [class.medium-score]="candidato.score_similitud <= 0.8 && candidato.score_similitud > 0.5">
                                            {{ candidato.score_similitud !== undefined ? (candidato.score_similitud |
                                            number:'1.2-2') : '-' }}
                                        </span>
                                    </td>
                                    <td class="text-sm reasoning-cell" [title]="candidato.razonamiento">{{
                                        candidato.razonamiento || '' }}</td>
                                </tr>
                            </ng-container>

                            <ng-template #noCandidatos>
                                <tr class="no-match-row">
                                    <!-- Ítem solicitado -->
                                    <td>{{ itemIndex + 1 }}</td>
                                    <td><strong>{{ item.nombre_item || item.item_key || '' }}</strong></td>
                                    <td class="text-center">{{ item.cantidad || '' }}</td>
                                    <!-- Sin candidatos span -->
                                    <td colspan="9" class="text-center text-muted"><em>Sin candidatos homologados (Score
                                            bajo o
                                            no encontrado en catálogo)</em></td>
                                </tr>
                            </ng-template>
                        </ng-container>
                    </tbody>
                </table>
            </div>

            <ng-template #emptyState>
                <div class="empty-state-card">
                    <p>No hay ítems homologados detectados para esta licitación.</p>
                    <p class="footer-note">Asegúrese de que el proceso de homologación haya sido completado en el
                        backend o que el catálogo posea coincidencias para este rubro.</p>
                </div>
            </ng-template>
        </div>
    </div>
</div>